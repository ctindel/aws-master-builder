service: ctindel-mb3-dynamodb-es

frameworkVersion: ">=1.1.0 <2.0.0"

# Note that you need to provide subnetIds for your private and public subnets
# And you need to configure a VPC s3 endpoint or else the lambda running in the
#  VPC won't be able to access s3.
#  https://aws.amazon.com/blogs/aws/new-vpc-endpoint-for-amazon-s3/
# Update the bucket names as appropriate also
provider:
  name: aws
  region: ${opt:region}
  runtime: nodejs8.10
  endpointType: REGIONAL
  role: arn:aws:iam::284628898641:role/ctindel-mb3-ESRole-16F7M3S07SVHV
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: "arn:aws:dynamodb:${opt:region, self:provider.region}:*:table/*"
    - Effect: "Allow"
      Action:
        - "s3:*"
      Resource:
        - "arn:aws:s3:::ctindel.amazon.com"
        - "arn:aws:s3:::ctindel.amazon.com/*"

resources:
  Resources:
    ProductDynamoDbTable:
      Type: 'AWS::DynamoDB::Table'
      #DeletionPolicy: Retain
      Properties:
        AttributeDefinitions:
          -
            AttributeName: id
            AttributeType: S
        KeySchema:
          -
            AttributeName: id
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        TableName: ctindel-mb3-product
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES

functions:
  product-dynamodb-es:
    handler: handler.handler
    environment:
      ES_ENDPOINT: https://search-ctindel-mb3-es2-i7lb3hukvelz4cvqlqumms2qly.us-east-2.es.amazonaws.com
      INDEX: product
      TYPE: _doc
    events:
      - stream:
         type: dynamodb
         arn:
           Fn::GetAtt: [ ProductDynamoDbTable, StreamArn ]
         batchSize: 1
         startingPosition: TRIM_HORIZON
